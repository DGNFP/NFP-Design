<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>NFP Design 관리자</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>

  <!-- 클립보드 이미지 붙여넣기 기능 -->
  <script>
    // CMS가 완전히 로드될 때까지 대기
    window.addEventListener('load', function() {
      // CMS 로드 확인을 위한 반복 체크
      const checkCMSLoaded = setInterval(() => {
        // 마크다운 에디터 영역 찾기
        const editorContainer = document.querySelector('.CodeMirror');
        if (editorContainer) {
          clearInterval(checkCMSLoaded);
          initClipboardPaste();
        }
      }, 1000);

      function initClipboardPaste() {
        console.log('클립보드 이미지 붙여넣기 기능 초기화됨');
        
        // 전체 문서에 paste 이벤트 리스너 추가
        document.addEventListener('paste', async function(e) {
          const items = e.clipboardData?.items;
          if (!items) return;

          // 현재 활성화된 마크다운 에디터 확인
          const activeEditor = document.querySelector('.CodeMirror-focused');
          if (!activeEditor) return;

          // 클립보드에서 이미지 찾기
          for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
              e.preventDefault(); // 기본 붙여넣기 방지
              
              const file = item.getAsFile();
              if (file) {
                await handleClipboardImage(file, activeEditor);
              }
              break;
            }
          }
        });
      }

      async function handleClipboardImage(file, editorElement) {
        try {
          // 로딩 상태 표시
          showUploadStatus('이미지 업로드 중...');

          // 파일명 생성 (timestamp 기반)
          const timestamp = Date.now();
          const extension = getFileExtension(file);
          const filename = `clipboard-${timestamp}.${extension}`;

          // FormData 생성
          const formData = new FormData();
          formData.append('file', file, filename);

          // 넷리파이 CMS의 미디어 업로드 API 호출
          // 실제 구현에서는 CMS의 내부 API를 사용해야 함
          const uploadUrl = await uploadToNetlifyCMS(formData);
          
          if (uploadUrl) {
            // 마크다운 이미지 문법으로 에디터에 삽입
            const markdownImage = `![클립보드 이미지](${uploadUrl})`;
            insertTextToEditor(markdownImage, editorElement);
            
            showUploadStatus('이미지 업로드 완료!', 'success');
          } else {
            throw new Error('업로드 실패');
          }

        } catch (error) {
          console.error('클립보드 이미지 업로드 오류:', error);
          showUploadStatus('이미지 업로드 실패', 'error');
        }
      }

      // 넷리파이 CMS 미디어 업로드 함수
      async function uploadToNetlifyCMS(formData) {
        try {
          // 방법 1: 넷리파이 CMS 내부 API 사용 (권장)
          if (window.CMS && window.CMS.getBackend) {
            const backend = window.CMS.getBackend();
            const mediaFile = formData.get('file');
            
            // CMS의 미디어 업로드 메서드 사용
            const result = await backend.persistMedia({
              file: mediaFile,
              path: `img/uploads/${mediaFile.name}`
            });
            
            return result.url || result.path;
          }

          // 방법 2: 직접 GitHub API 호출 (대안)
          // 실제 구현에서는 GitHub Personal Access Token이 필요
          const response = await fetch('/admin/api/media/upload', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            return result.url;
          }

          throw new Error('업로드 실패');

        } catch (error) {
          console.error('업로드 오류:', error);
          return null;
        }
      }

      // 에디터에 텍스트 삽입
      function insertTextToEditor(text, editorElement) {
        try {
          // CodeMirror 인스턴스 가져오기
          const codeMirror = editorElement.CodeMirror;
          if (codeMirror) {
            const cursor = codeMirror.getCursor();
            codeMirror.replaceRange(text, cursor);
            codeMirror.focus();
          }
        } catch (error) {
          console.error('텍스트 삽입 오류:', error);
        }
      }

      // 파일 확장자 추출
      function getFileExtension(file) {
        const type = file.type;
        switch (type) {
          case 'image/png': return 'png';
          case 'image/jpeg': return 'jpg';
          case 'image/gif': return 'gif';
          case 'image/webp': return 'webp';
          default: return 'png';
        }
      }

      // 업로드 상태 표시
      function showUploadStatus(message, type = 'info') {
        // 기존 상태 메시지 제거
        const existingStatus = document.querySelector('.clipboard-upload-status');
        if (existingStatus) {
          existingStatus.remove();
        }

        // 새 상태 메시지 생성
        const statusDiv = document.createElement('div');
        statusDiv.className = `clipboard-upload-status clipboard-${type}`;
        statusDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 16px;
          border-radius: 4px;
          color: white;
          font-weight: bold;
          z-index: 10000;
          background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;
        statusDiv.textContent = message;

        document.body.appendChild(statusDiv);

        // 3초 후 자동 제거
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.remove();
          }
        }, 3000);
      }

    });
  </script>

  <style>
    /* 클립보드 이미지 업로드 관련 스타일 */
    .clipboard-upload-status {
      transition: all 0.3s ease;
    }
    
    /* 에디터 영역에 드래그 앤 드롭 힌트 추가 */
    .CodeMirror-focused {
      position: relative;
    }
    
    .CodeMirror-focused::after {
      content: "💡 Ctrl+V로 클립보드 이미지를 바로 붙여넣을 수 있어요!";
      position: absolute;
      bottom: -30px;
      left: 0;
      font-size: 12px;
      color: #666;
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</body>
</html>