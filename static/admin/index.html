<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>NFP Design ê´€ë¦¬ì</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }
  </script>

  <!-- í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ -->
  <script>
    // CMSê°€ ì™„ì „íˆ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    window.addEventListener('load', function() {
      // CMS ë¡œë“œ í™•ì¸ì„ ìœ„í•œ ë°˜ë³µ ì²´í¬
      const checkCMSLoaded = setInterval(() => {
        // ë§ˆí¬ë‹¤ìš´ ì—ë””í„° ì˜ì—­ ì°¾ê¸°
        const editorContainer = document.querySelector('.CodeMirror');
        if (editorContainer) {
          clearInterval(checkCMSLoaded);
          initClipboardPaste();
        }
      }, 1000);

      function initClipboardPaste() {
        console.log('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ê¸°ëŠ¥ ì´ˆê¸°í™”ë¨');
        
        // ì „ì²´ ë¬¸ì„œì— paste ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('paste', async function(e) {
          const items = e.clipboardData?.items;
          if (!items) return;

          // í˜„ì¬ í™œì„±í™”ëœ ë§ˆí¬ë‹¤ìš´ ì—ë””í„° í™•ì¸
          const activeEditor = document.querySelector('.CodeMirror-focused');
          if (!activeEditor) return;

          // í´ë¦½ë³´ë“œì—ì„œ ì´ë¯¸ì§€ ì°¾ê¸°
          for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
              e.preventDefault(); // ê¸°ë³¸ ë¶™ì—¬ë„£ê¸° ë°©ì§€
              
              const file = item.getAsFile();
              if (file) {
                await handleClipboardImage(file, activeEditor);
              }
              break;
            }
          }
        });
      }

      async function handleClipboardImage(file, editorElement) {
        try {
          // ë¡œë”© ìƒíƒœ í‘œì‹œ
          showUploadStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');

          // íŒŒì¼ëª… ìƒì„± (timestamp ê¸°ë°˜)
          const timestamp = Date.now();
          const extension = getFileExtension(file);
          const filename = `clipboard-${timestamp}.${extension}`;

          // FormData ìƒì„±
          const formData = new FormData();
          formData.append('file', file, filename);

          // ë„·ë¦¬íŒŒì´ CMSì˜ ë¯¸ë””ì–´ ì—…ë¡œë“œ API í˜¸ì¶œ
          // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” CMSì˜ ë‚´ë¶€ APIë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
          const uploadUrl = await uploadToNetlifyCMS(formData);
          
          if (uploadUrl) {
            // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ë¬¸ë²•ìœ¼ë¡œ ì—ë””í„°ì— ì‚½ì…
            const markdownImage = `![í´ë¦½ë³´ë“œ ì´ë¯¸ì§€](${uploadUrl})`;
            insertTextToEditor(markdownImage, editorElement);
            
            showUploadStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ!', 'success');
          } else {
            throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');
          }

        } catch (error) {
          console.error('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          showUploadStatus('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨', 'error');
        }
      }

      // ë„·ë¦¬íŒŒì´ CMS ë¯¸ë””ì–´ ì—…ë¡œë“œ í•¨ìˆ˜
      async function uploadToNetlifyCMS(formData) {
        try {
          // ë°©ë²• 1: ë„·ë¦¬íŒŒì´ CMS ë‚´ë¶€ API ì‚¬ìš© (ê¶Œì¥)
          if (window.CMS && window.CMS.getBackend) {
            const backend = window.CMS.getBackend();
            const mediaFile = formData.get('file');
            
            // CMSì˜ ë¯¸ë””ì–´ ì—…ë¡œë“œ ë©”ì„œë“œ ì‚¬ìš©
            const result = await backend.persistMedia({
              file: mediaFile,
              path: `img/uploads/${mediaFile.name}`
            });
            
            return result.url || result.path;
          }

          // ë°©ë²• 2: ì§ì ‘ GitHub API í˜¸ì¶œ (ëŒ€ì•ˆ)
          // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub Personal Access Tokenì´ í•„ìš”
          const response = await fetch('/admin/api/media/upload', {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            const result = await response.json();
            return result.url;
          }

          throw new Error('ì—…ë¡œë“œ ì‹¤íŒ¨');

        } catch (error) {
          console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
          return null;
        }
      }

      // ì—ë””í„°ì— í…ìŠ¤íŠ¸ ì‚½ì…
      function insertTextToEditor(text, editorElement) {
        try {
          // CodeMirror ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
          const codeMirror = editorElement.CodeMirror;
          if (codeMirror) {
            const cursor = codeMirror.getCursor();
            codeMirror.replaceRange(text, cursor);
            codeMirror.focus();
          }
        } catch (error) {
          console.error('í…ìŠ¤íŠ¸ ì‚½ì… ì˜¤ë¥˜:', error);
        }
      }

      // íŒŒì¼ í™•ì¥ì ì¶”ì¶œ
      function getFileExtension(file) {
        const type = file.type;
        switch (type) {
          case 'image/png': return 'png';
          case 'image/jpeg': return 'jpg';
          case 'image/gif': return 'gif';
          case 'image/webp': return 'webp';
          default: return 'png';
        }
      }

      // ì—…ë¡œë“œ ìƒíƒœ í‘œì‹œ
      function showUploadStatus(message, type = 'info') {
        // ê¸°ì¡´ ìƒíƒœ ë©”ì‹œì§€ ì œê±°
        const existingStatus = document.querySelector('.clipboard-upload-status');
        if (existingStatus) {
          existingStatus.remove();
        }

        // ìƒˆ ìƒíƒœ ë©”ì‹œì§€ ìƒì„±
        const statusDiv = document.createElement('div');
        statusDiv.className = `clipboard-upload-status clipboard-${type}`;
        statusDiv.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 12px 16px;
          border-radius: 4px;
          color: white;
          font-weight: bold;
          z-index: 10000;
          background-color: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
          box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;
        statusDiv.textContent = message;

        document.body.appendChild(statusDiv);

        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
          if (statusDiv.parentNode) {
            statusDiv.remove();
          }
        }, 3000);
      }

    });
  </script>

  <style>
    /* í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .clipboard-upload-status {
      transition: all 0.3s ease;
    }
    
    /* ì—ë””í„° ì˜ì—­ì— ë“œë˜ê·¸ ì•¤ ë“œë¡­ íŒíŠ¸ ì¶”ê°€ */
    .CodeMirror-focused {
      position: relative;
    }
    
    .CodeMirror-focused::after {
      content: "ğŸ’¡ Ctrl+Vë¡œ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ë¥¼ ë°”ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆì–´ìš”!";
      position: absolute;
      bottom: -30px;
      left: 0;
      font-size: 12px;
      color: #666;
      opacity: 0.7;
      pointer-events: none;
    }
  </style>
</body>
</html>