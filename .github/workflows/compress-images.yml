name: ğŸ—œï¸ Smart Image Processing

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ë§Œ
  
jobs:
  compress:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: ğŸ› ï¸ Install ImageMagick with WebP support
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick webp
    
    - name: ğŸŒ Smart WebP Generation (ì›ë³¸ íŒŒì¼ë§Œ)
      run: |
        echo "ğŸ”„ Processing ONLY original images..."
        
        # ì›ë³¸ íŒŒì¼ë§Œ ì°¾ê¸° (ì–¸ë”ìŠ¤ì½”ì–´ ì—†ëŠ” íŒŒì¼)
        find static/img/uploads -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | grep -v "_" | while read img; do
          filename=$(basename "$img")
          dirname=$(dirname "$img")
          name="${filename%.*}"
          
          echo "ğŸ” Checking: $img"
          
          # WebPê°€ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "${dirname}/${name}.webp" ]; then
            echo "ğŸ†• Creating WebP: ${name}.webp"
            cwebp -q 85 "$img" -o "${dirname}/${name}.webp"
          fi
          
          # ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "${dirname}/${name}_thumb.jpg" ]; then
            echo "ğŸ†• Creating thumbnail: ${name}_thumb.jpg"
            convert "$img" -resize 300x200^ -gravity center -crop 300x200+0+0 "${dirname}/${name}_thumb.jpg"
            cwebp -q 80 "${dirname}/${name}_thumb.jpg" -o "${dirname}/${name}_thumb.webp"
          fi
          
          # ì¤‘ê°„í¬ê¸°ê°€ ì—†ìœ¼ë©´ ìƒì„±
          if [ ! -f "${dirname}/${name}_medium.jpg" ]; then
            echo "ğŸ†• Creating medium: ${name}_medium.jpg"
            convert "$img" -resize 600x400^ -gravity center -crop 600x400+0+0 "${dirname}/${name}_medium.jpg"
            cwebp -q 80 "${dirname}/${name}_medium.jpg" -o "${dirname}/${name}_medium.webp"
          fi
          
        done
        
        echo "ğŸ‰ Smart processing completed!"
        
    - name: ğŸ“¤ Commit changes
      run: |
        git config --local user.email "nfp-compress-bot@github.com"
        git config --local user.name "NFP Compress Bot"
        git add static/img/uploads/
        if git diff --cached --quiet; then
          echo "ğŸ“¸ No changes to commit"
        else
          git commit -m "ğŸ—œï¸ Smart image processing [skip ci]"
          git push
          echo "âœ… Changes committed"
        fi