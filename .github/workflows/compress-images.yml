name: 🗜️ Smart Image Processing

on:
  workflow_dispatch: # 수동 실행만
  
jobs:
  compress:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📂 Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: 🛠️ Install ImageMagick with WebP support
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick webp
    
    - name: 🌐 Smart WebP Generation (원본 파일만)
      run: |
        echo "🔄 Processing ONLY original images..."
        
        # 원본 파일만 찾기 (언더스코어 없는 파일)
        find static/img/uploads -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | grep -v "_" | while read img; do
          filename=$(basename "$img")
          dirname=$(dirname "$img")
          name="${filename%.*}"
          
          echo "🔍 Checking: $img"
          
          # WebP가 없으면 생성
          if [ ! -f "${dirname}/${name}.webp" ]; then
            echo "🆕 Creating WebP: ${name}.webp"
            cwebp -q 85 "$img" -o "${dirname}/${name}.webp"
          fi
          
          # 썸네일이 없으면 생성
          if [ ! -f "${dirname}/${name}_thumb.jpg" ]; then
            echo "🆕 Creating thumbnail: ${name}_thumb.jpg"
            convert "$img" -resize 300x200^ -gravity center -crop 300x200+0+0 "${dirname}/${name}_thumb.jpg"
            cwebp -q 80 "${dirname}/${name}_thumb.jpg" -o "${dirname}/${name}_thumb.webp"
          fi
          
          # 중간크기가 없으면 생성
          if [ ! -f "${dirname}/${name}_medium.jpg" ]; then
            echo "🆕 Creating medium: ${name}_medium.jpg"
            convert "$img" -resize 600x400^ -gravity center -crop 600x400+0+0 "${dirname}/${name}_medium.jpg"
            cwebp -q 80 "${dirname}/${name}_medium.jpg" -o "${dirname}/${name}_medium.webp"
          fi
          
        done
        
        echo "🎉 Smart processing completed!"
        
    - name: 📤 Commit changes
      run: |
        git config --local user.email "nfp-compress-bot@github.com"
        git config --local user.name "NFP Compress Bot"
        git add static/img/uploads/
        if git diff --cached --quiet; then
          echo "📸 No changes to commit"
        else
          git commit -m "🗜️ Smart image processing [skip ci]"
          git push
          echo "✅ Changes committed"
        fi