name: ğŸ—œï¸ Auto Compress Images & Generate WebP

on:
  push:
    branches:
      - main
  workflow_dispatch: 

jobs:
  compress:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‚ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    # ImageMagick ì„¤ì¹˜ (WebP ì§€ì›)
    - name: ğŸ› ï¸ Install ImageMagick with WebP support
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick webp
    
    # ê¸°ì¡´ ì´ë¯¸ì§€ ì••ì¶•
    - name: ğŸ—œï¸ Compress Images
      uses: calibreapp/image-actions@main
      with:
        githubToken: ${{ secrets.GITHUB_TOKEN }}
        compressOnly: true
        jpegQuality: 85
        pngQuality: 85
        webpQuality: 85
        ignorePaths: 'node_modules/**,dist/**,.git/**'
    
    # WebP ë³€í™˜ ë° ì¸ë„¤ì¼ ìƒì„±
    - name: ğŸŒ Generate WebP and Thumbnails
      run: |
        echo "ğŸ”„ Converting images to WebP format..."
        
        # static/img/uploads í´ë”ì˜ ëª¨ë“  ì´ë¯¸ì§€ ì²˜ë¦¬
        find static/img/uploads -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | while read img; do
          filename=$(basename "$img")
          dirname=$(dirname "$img")
          name="${filename%.*}"
          
          echo "Processing: $img"
          
          # 1. WebP ë³€í™˜ (ì›ë³¸ í¬ê¸°)
          cwebp -q 85 "$img" -o "${dirname}/${name}.webp"
          
          # 2. ì¸ë„¤ì¼ ìƒì„± (300x200)
          convert "$img" -resize 300x200^ -gravity center -crop 300x200+0+0 "${dirname}/${name}_thumb.jpg"
          cwebp -q 80 "${dirname}/${name}_thumb.jpg" -o "${dirname}/${name}_thumb.webp"
          
          # 3. ì¤‘ê°„ í¬ê¸° ìƒì„± (600x400)
          convert "$img" -resize 600x400^ -gravity center -crop 600x400+0+0 "${dirname}/${name}_medium.jpg"
          cwebp -q 80 "${dirname}/${name}_medium.jpg" -o "${dirname}/${name}_medium.webp"
          
          echo "âœ… Generated WebP versions for $filename"
        done
        
        echo "ğŸ‰ WebP conversion completed!"
        
    - name: ğŸ“¤ Commit compressed images and WebP files
      run: |
        git config --local user.email "nfp-compress-bot@github.com"
        git config --local user.name "NFP Compress Bot"
        git add static/img/uploads/
        if git diff --cached --quiet; then
          echo "ğŸ“¸ No images to compress or convert"
        else
          git commit -m "ğŸ—œï¸ Auto compress images and generate WebP variants [skip ci]"
          git push
          echo "âœ… Images compressed and WebP variants generated"
        fi